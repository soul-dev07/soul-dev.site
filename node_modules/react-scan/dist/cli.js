"use strict";var e=Object.create,t=Object.defineProperty,a=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,r=Object.getPrototypeOf,i=Object.prototype.hasOwnProperty,o=(o,c,l)=>(l=null!=o?e(r(o)):{},((e,r,o,c)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let l of n(r))i.call(e,l)||l===o||t(e,l,{get:()=>r[l],enumerable:!(c=a(r,l))||c.enumerable});return e})(!c&&o&&o.__esModule?l:t(l,"default",{value:o,enumerable:!0}),o)),c=require("child_process"),l=require("playwright"),s=o(require("mri"),1),u=require("@clack/prompts"),d=require("kleur"),w=o(require("fs"),1),p=o(require("path"),1),h=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.2227.0 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.3497.92 Safari/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36"];(async()=>{(0,u.intro)(`${(0,d.bgMagenta)("[·]")} React Scan`);const e=(0,s.default)(process.argv.slice(2));let t;const a=l.devices[e.device],{browserType:n,channel:r}=await(async e=>{switch(e){case"firefox":return{browserType:l.firefox,channel:void 0,name:"firefox"};case"webkit":return{browserType:l.webkit,channel:void 0,name:"webkit"};default:return{browserType:l.chromium,channel:"chrome",name:"chrome"}}})(e.browser),i={headless:!1,channel:r,...a,acceptDownloads:!0,viewport:null,locale:"en-US",timezoneId:"America/New_York",args:["--enable-webgl","--use-gl=swiftshader","--enable-accelerated-2d-canvas","--disable-blink-features=AutomationControlled","--disable-web-security"],userAgent:h[Math.floor(Math.random()*h.length)],bypassCSP:!0};try{t=await n.launch({headless:!1,channel:r})}catch{}if(!t)try{t=await n.launch({headless:!1})}catch{await new Promise((async(e,t)=>{const a=await(0,u.confirm)({message:"No drivers found. Install Playwright Chromium driver to continue?"});if((0,u.isCancel)(a)&&((0,u.cancel)("Operation cancelled."),process.exit(0)),!a)return process.exit(0);const n=(0,c.spawn)("npx",["playwright@latest","install","chromium"],{stdio:"inherit"});n.on("close",(a=>{if(!a)return e();t(new Error(`Installation process exited with code ${a}`))})),n.on("error",(e=>{t(e)}))}));try{t=await l.chromium.launch({headless:!1})}catch{(0,u.cancel)("No browser could be launched. Please run `npx playwright install` to install browser drivers.")}}if(!t)return void(0,u.cancel)("No browser could be launched. Please run `npx playwright install` to install browser drivers.");const o=await t.newContext(i);await(async e=>{await e.addInitScript((()=>{Object.defineProperty(navigator,"webdriver",{get:()=>{}}),Object.defineProperty(navigator,"languages",{get:()=>["en-US","en"]}),Object.defineProperty(navigator,"plugins",{get:()=>[1,2,3,4,5]}),delete window.__playwright,delete window.__pw_manual,delete window.__PW_inspect,Object.defineProperty(navigator,"headless",{get:()=>!1});const e=window.navigator.permissions.query;window.navigator.permissions.query=t=>"notifications"===t.name?Promise.resolve({state:Notification.permission}):e(t)}))})(o),await o.addInitScript({content:"(() => {\n      const NO_OP = () => {};\n      let i = 0;\n      globalThis.__REACT_DEVTOOLS_GLOBAL_HOOK__ = {\n        checkDCE: NO_OP,\n        supportsFiber: true,\n        renderers: new Map(),\n        onScheduleFiberRoot: NO_OP,\n        onCommitFiberRoot: NO_OP,\n        onCommitFiberUnmount: NO_OP,\n        inject(renderer) {\n          const nextID = ++i;\n          this.renderers.set(nextID, renderer);\n          return nextID;\n        },\n      };\n    })();"});const b=await o.newPage(),m=w.default.readFileSync(p.default.resolve(__dirname,"./auto.global.js"),"utf8"),_=(e=>{try{return new URL(e).href}catch{try{return new URL(`https://${e}`).href}catch{return"about:blank"}}})(e._[0]||"about:blank");await b.goto(_),await b.waitForLoadState("load"),await b.waitForTimeout(500),await b.addScriptTag({content:`${m}\n//# sourceURL=react-scan.js`});let f,g,y=0,O=_;const S=async e=>{g&&clearInterval(g),O=e,f?.stop(`${e}${y?` (×${y})`:""}`),f=(0,u.spinner)(),f.start((0,d.dim)(`Scanning: ${e}`)),y=0;try{await b.waitForLoadState("load"),await b.waitForTimeout(500);await b.evaluate((()=>Boolean(globalThis.__REACT_SCAN__)))||await b.addScriptTag({content:m}),await b.waitForTimeout(100),await b.evaluate((()=>{"function"==typeof globalThis.reactScan&&(globalThis.reactScan({report:!0}),globalThis.__REACT_SCAN__.ReactScanInternals.reportData={})})),g=setInterval((()=>{(async()=>{b.url()===O&&await b.evaluate((()=>{const e=globalThis.__REACT_SCAN__;if(!e)return;const t=e.ReactScanInternals.reportData;Object.keys(t).length&&console.log("REACT_SCAN_REPORT",JSON.stringify(t,((e,t)=>["prevValue","nextValue"].includes(e)?void 0:t)))})).catch((()=>{}))})()}),1e3)}catch(t){f?.stop((0,d.red)(`Failed to inject React Scan to: ${e}`))}};await S(_),b.on("framenavigated",(async e=>{if(e!==b.mainFrame())return;const t=e.url();S(t)})),b.on("console",(async e=>{const t=e.text();if(!t.startsWith("REACT_SCAN_REPORT"))return;const a=t.replace("REACT_SCAN_REPORT","").trim(),n=JSON.parse(a);let r=0;for(const e in n){r+=n[e].count}const i=e.location().url;i===O?(y=r,f&&f.message((0,d.dim)(`Scanning: ${O}${y?` (×${y})`:""}`))):f?.stop(`${i}${y?` (×${y})`:""}`)}))})();