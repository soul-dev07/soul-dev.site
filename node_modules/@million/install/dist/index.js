#!/usr/bin/env node
"use strict";var e=require("path"),n=require("process"),t=require("@clack/prompts"),i=require("tty"),a=require("crypto"),r=require("@axiomhq/js"),o=require("os"),l=require("fs"),s=require("fs/promises"),c=require("child_process"),u=require("util"),d=require("diff"),f=require("@antfu/ni"),p=require("@babel/core"),g=require("@babel/types");function m(e){return e&&e.__esModule?e:{default:e}}function y(e){if(e&&e.__esModule)return e;var n=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})}})),n.default=e,Object.freeze(n)}var b,h=m(e),w=m(n),v=y(t),k=m(o),x=y(l),j=m(s),C=m(u),$=y(d),F=y(g),M={reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgGray:[100,49],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49],blackStylize:["#121212","#eeeeee18"],redStylize:["#cb7676","#ab5959"],greenStylize:["#4d9375","#1e754f"],yellowStylize:["#f6c177","#f6c17790"],blueStylize:["#6394bf","#296aa3"],magentaStylize:["#c391e6","#c391e690"],pinkStylize:["#ed9cc2","#ed9cc290"],cyanStylize:["#5eaab5","#2993a3"],whiteStylize:["#ffffff","#ffffff9f"],grayStylize:["#888888","#444444"]},S=i.WriteStream.prototype.hasColors(),I=(e,n)=>{if(!S)return e=>e;const t=`[${e}m`,i=`[${n}m`;return e=>{const n=`${e}`;let a=n.indexOf(i);if(-1===a)return t+n+i;let r=t,o=0;for(;-1!==a;)r+=n.slice(o,a)+t,o=a+i.length,a=n.indexOf(i,o);return r+=n.slice(o)+i,r}},L=(b=(e,n,t)=>I(`38;2;${e};${n};${t}`,39),e=>{const[n,t,i]=(e=>{let[,n]=/([\da-f]{3,6})/i.exec(e)||[];const t=n?n.length:0;if(3===t)n=n[0]+n[0]+n[1]+n[1]+n[2]+n[2];else if(6!==t)return[0,0,0];const i=Number.parseInt(n,16);return[i>>16&255,i>>8&255,255&i]})(e);return b(n,t,i)}),N=I(...M.bold),E=I(...M.dim),z=I(...M.cyanBright);L(M.blackStylize[0]),L(M.blackStylize[1]);var P=L(M.redStylize[0]);L(M.redStylize[1]);var A=L(M.greenStylize[0]);L(M.greenStylize[1]);var O=L(M.yellowStylize[0]);L(M.yellowStylize[1]),L(M.blueStylize[0]),L(M.blueStylize[1]);var D=L(M.magentaStylize[0]);L(M.magentaStylize[1]);var _=L(M.pinkStylize[0]);L(M.pinkStylize[1]);var R=L(M.cyanStylize[0]);L(M.cyanStylize[1]),L(M.whiteStylize[0]);var B=L(M.whiteStylize[1]),V=L(M.grayStylize[0]);L(M.grayStylize[1]);var T,q,W="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",U=128;function G(e=21){var n;n=e-=0,!T||T.length<n?(T=Buffer.allocUnsafe(n*U),a.webcrypto.getRandomValues(T),q=0):q+n>T.length&&(a.webcrypto.getRandomValues(T),q=0);let t="";for(let i=(q+=n)-e;i<q;i++)t+=W[63&T[i]];return t}var J=(e=>{const n=k.default.homedir();switch(process.platform){case"darwin":return h.default.join(n,"Library","Preferences",e);case"win32":return(()=>{const{APPDATA:t=h.default.join(n,"AppData","Roaming")}=process.env;return h.default.join(t,e,"Config")})();default:return(()=>{const{XDG_CONFIG_HOME:t=h.default.join(n,".config")}=process.env;return h.default.join(t,e)})()}})("million-lint"),H=a.randomUUID(),Y=async()=>{if(!H)try{x.default.statSync(h.default.join(J,"machineId.txt")).isFile()&&(H=x.default.readFileSync(h.default.join(J,"machineId.txt"),"utf8")||H)}catch(e){}return H},K=new r.Axiom({token:"xaat-bdc47730-5a10-4b01-b47c-e6b9615dc49e"}),X=async(e,...n)=>{K.ingest("install",{level:e,env:Xe,machineId:Y(),message:JSON.stringify(n)}),await K.flush()},Z=K.flush;function Q({type:e="error",distinctId:n=`r-${G(10)}`,event:t,message:i,properties:a={},needAbort:r}){if(r)return function({title:e,message:n,properties:t={},status:i,distinctId:a=`r-${G(10)}`,type:r="error"}){X("error",{distinctId:a,title:e,message:n,...t}),n&&v.log[r](n);"error"===r&&(v.log.error(`${P("Setup failed.")} Continue via ${R("http://million.dev/docs")}`),v.log.message());ee().then((()=>process.exit(i??1)))}({title:t,message:i,type:e});i?("error"===e?v.log.error(i):v.note(i,t),X(e,{distinctId:n,event:t,message:i,...a})):X(e,{distinctId:n,event:t,...a})}var ee=async()=>{try{await Z()}catch{process.exit(1)}};async function ne(e,n){const t=await e;if(!v.isCancel(t))return e;Q({event:"wizard-cancel",properties:{body:t}}),n&&await n(),v.cancel("Million Lint setup cancelled."),await ee(),process.exit(1)}function te(e,n,t,i=1){const a=$.diffWords(e,n);let r="";a.forEach(((e,n)=>{const t=n>0&&(a[n-1]?.added||a[n-1]?.removed),o=n<a.length-1&&(a[n+1]?.added||a[n+1]?.removed);let l="";if(e.added)l=A(N(e.value));else if(e.removed)l=P(e.value);else if(t&&o){const n=e.value.split("\n");l=n.length-1>2*i?[n.slice(0,i).join("\n"),"...",n.slice(-i-1).join("\n")].join("\n"):E(e.value)}else t?l=e.value.split("\n").slice(0,i+1).join("\n"):o&&(l=e.value.split("\n").slice(-i-1).join("\n"));r+=l})),v.note(r,`Take a look at changes in ${R(t)}`)}var ie=C.default.promisify(c.exec);var ae=(e,n)=>{try{let t=!1;const i=((e,n)=>{let t;return new Promise(((i,a)=>{e.then((e=>{t&&clearTimeout(t),i(e)})).catch((()=>{a(new Error)})),t=setTimeout((()=>{a(new Error)}),n)}))})(e,n).catch((()=>{t=!0}));if(t)return;return i}catch(e){return}};var re=[{label:"Visual Studio Code",value:"code"},{label:"Visual Studio Code Insiders",value:"code-insiders"},{label:"Cursor",value:"cursor"}],oe=async e=>{e.stop(`Unable to install via CLI. Install here: ${z("https://marketplace.visualstudio.com/items?itemName=million.million-lint")}`),Q({event:"wizard-cli-install-failed"});await ne(t.confirm({message:"Would you like to continue anyway?"}))||process.exit(0)},le=async()=>{const e=t.spinner(),n=(await Promise.all(re.map((e=>(async e=>{try{const n=await ae(ie(`${e.value} --version`),3e3);if(n.stderr)return Q({event:"wizard-command-check-failed",message:n.stderr}),null;if(n?.stdout)return e}catch{}return null})(e))))).filter(Boolean);if(e.start("Installing VSCode extension"),n.length){let i=Xe.CLI_COMMAND;n.length>1&&(i=await ne(t.select({message:"Which IDE are you using?",options:n.map((e=>({label:e.label,value:e.value})))}))),Xe.CLI_COMMAND=String(i),Xe.IDE_NAME=re.find((e=>e.value===i))?.label||null,Xe.IDE_VERSION=await(async e=>{try{const n=await ae(ie(`${e} --version`),3e3);if(n.stderr)return Q({event:"wizard-command-version-failed",message:n.stderr}),null;if(n?.stdout)return n.stdout.split("\n")[0]}catch{}return null})(i);const a=await(async e=>{try{const n=await ae(ie(`${e} --list-extensions --show-versions`),3e3);if(n?.stderr)return Q({event:"wizard-extension-check-failed",message:n?.stderr}),!1;const t=n?.stdout.split("\n");if(t)for(const e of t)if(e.includes("million.million-lint"))return Xe.MILLION_VERSION=e,!0}catch{}return!1})(i);await(async()=>{const e=await ae(ie(`${Xe.CLI_COMMAND} --install-extension million.million-lint --force`),2e4);return e?.stderr?(Q({event:"wizard-extension-install-failed",message:e?.stderr}),!1):Boolean(!e?.stdout.toLowerCase().includes("failed")&&e?.stdout)})()?a?e.stop("Updated VSCode extension"):e.stop("Installed VSCode extension"):await oe(e)}else await oe(e)},se={name:"yarn",label:"yarn",lockFile:"yarn.lock",installCommand:"yarn add",dlxCommand:"npx"},ce={name:"pnpm",label:"pnpm",lockFile:"pnpm-lock.yaml",installCommand:"pnpm install",dlxCommand:"pnpx"},ue={name:"npm",label:"npm",lockFile:"package-lock.json",installCommand:"npm install",dlxCommand:"npx"},de={name:"bun",label:"bun",lockFile:"bun.lockb",installCommand:"bun add",dlxCommand:"bunx"},fe=[ce,se,de,ue],pe={name:"craco",label:"Create React App",bundler:"webpack",prefix:"MillionLint.craco",configFilePath:"craco.config.js",possibleFileNames:["craco.config.js","craco.config.mjs","craco.config.cjs","craco.config.ts"],millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [MillionLint.craco()],\n};"}},ge=[{name:"next",label:"Next.js",bundler:"next",prefix:"MillionLint.next",configFilePath:"next.config.mjs",possibleFileNames:["next.config.js","next.config.mjs"],millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next()(nextConfig);",configFileContentRSC:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next({ rsc: true })(nextConfig);"}},{name:"astro",label:"Astro",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"astro.config.mjs",possibleFileNames:["astro.config.js","astro.config.mjs","astro.config.cjs","astro.config.ts"],millionLint:{configFileContent:"import { defineConfig } from 'astro/config';\nimport MillionLint from '@million/lint';\n\nexport default defineConfig({\n  integrations: [MillionLint.astro()]\n});"}},{name:"gatsby",label:"Gatsby",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"gatsby-node.js",possibleFileNames:["gatsby-node.js","gatsby-node.ts"],otherPossibleFileNames:["gatsby-config.js","gatsby-config.ts"],millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\n\nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [MillionLint.webpack()],\n  })\n};"}},{name:"vite",label:"Vite",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"vite.config.js",possibleFileNames:["vite.config.js","vite.config.mjs","vite.config.mts","vite.config.cjs","vite.config.ts"],millionLint:{configFileContent:"import MillionLint from '@million/lint';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [MillionLint.vite(), react()],\n});"}},pe,{name:"webpack",label:"Webpack",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"webpack.config.js",possibleFileNames:["webpack.config.js","webpack.config.cjs","webpack.config.mjs","webpack.config.ts"],millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [\n    MillionLint.webpack(),\n  ],\n};"}},{name:"rollup",label:"Rollup",bundler:"rollup",prefix:"MillionLint.rollup",configFilePath:"rollup.config.js",possibleFileNames:["rollup.config.js","rollup.config.mjs","rollup.config.cjs","rollup.config.ts"],millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\nexport default {\n  plugins: [MillionLint.rollup()],\n};"}}];async function me({packageManager:e,packageNames:n,flags:t=[],cwd:i}){try{const a=`${e.installCommand} ${n.map((e=>`${e}@latest`)).join(" ")} ${t.join(" ")}`;v.log.info(`Running: ${a}`);const{stderr:r}=await ie(a,{cwd:i});if(r){v.log.error(P(r)),"npm"===e.name&&t.push("--legacy-peer-deps"),"yarn"!==e.name&&"pnpm"!==e.name||t.push("--ignore-workspace-root-check");const o=`${e.installCommand} ${n.map((e=>`${e}@latest`)).join(" ")} ${t.join(" ")}`;if(o===a)return;v.log.info(`Running: ${o}`);const{stderr:l}=await ie(o,{cwd:i});l&&v.log.error(P(l))}}catch(e){Q({event:"wizard-failed-install-package",message:e.stdout||e.stderr||e.message,properties:{body:e},needAbort:!0})}}var ye=null;async function be(e){if(ye)return ye;const n=await async function(e){const n=await f.detect({cwd:e});if(!n)return null;const[t]=n.split("@");switch(t){case"yarn":return se;case"pnpm":return ce;case"npm":return ue;case"bun":return de;default:return null}}(e);if(n)ye=n;else{const e=await ne(v.select({message:"Please select your package manager.",options:fe.map((e=>({value:e,label:e.label,hint:`Be sure you have ${N(e.label)} installed.`})))}));ye=e}return ye}function he(e){return!!e&&!!e.includes("react-scripts start")}async function we(e,n,t){if(he(e)){let i=e;i=i.replace("react-scripts start","craco start"),i=i.replace("react-scripts build","craco build"),i=i.replace("react-scripts test","craco test");const a=["@craco/craco",...n].map((e=>R(N(e)))).join(", ");try{const e=await be(t);await x.promises.writeFile(h.default.join(t,"package.json"),i),await x.promises.writeFile(h.default.join(t,"craco.config.js"),pe.millionLint.configFileContent);const r=v.spinner();r.start(`Installing ${a}...`),await me({packageManager:e,packageNames:["@craco/craco"],cwd:t,flags:["-D"]}),await me({packageManager:e,packageNames:n,cwd:t}),r.stop(`${a} installed.`)}catch(e){return Q({event:"wizard-error-install-craco",message:`Could not install ${a}. Please install it manually.`,properties:{body:e}})}}}async function ve(e){const n=await async function(e){let n;try{n=await j.default.readFile(h.default.join(e,"package.json"),"utf8")}catch{return void Q({event:"wizard-package-json-not-found",message:"Could not find package.json. Make sure to run the wizard in the root of your app!"})}return n}(e);if(!n)return;let t;try{t=JSON.parse(n)}catch{return Q({event:"wizard-package-json-parse-error",message:"Unable to parse your package.json. Make sure it has a valid format!",needAbort:!0})}return{packageJson:t,packageJsonContents:n}}var ke=async()=>{const e=Xe.CWD,n=await ve(e);if(!n)return;const t=await async function({packageJsonContents:e,packages:n,cwd:t}){const i=[];for(const a of ge){if("craco"===a.name&&he(e))return await ne(await v.confirm({message:"Ordinary create-react-app projects are not supported. Do you want to use craco instead of react-scripts?"}))?(Xe.INIT_CRACO=!0,void await we(e,n,t)):void Q({event:"wizard-craco-not-installed",message:"Please install craco manually: https://craco.js.org/docs/getting-started",needAbort:!0});for(const e of a.possibleFileNames)if(x.existsSync(h.default.join(t,e))){const n={...a,configFilePath:e};i.push({buildTool:n})}else if(x.existsSync(h.default.join(t,"config",e))){const n={...a,configFilePath:h.default.join("config",e)};i.push({buildTool:n})}if("gatsby"===a.name)for(const e of a.otherPossibleFileNames)if(x.existsSync(h.default.join(t,e))){const e=a;await x.promises.writeFile(h.default.join(t,a.configFilePath),a.millionLint.configFileContent),i.push({buildTool:e,skipUpdateConfigFile:!0})}}if(i.length){if(1===i.length)return v.log.success(`Detected ${R(N(i[0].buildTool.label))} project.`),i[0];const e=await ne(await v.select({message:"Detected multiple build tools. Please select one:",options:i.map((e=>({label:e.buildTool.label,value:e.buildTool.name,hint:e.buildTool.configFilePath}))),initialValue:i[0].buildTool.name}));return i.find((n=>n.buildTool.name===e))}Q({event:"wizard-no-build-tool-detected",message:`No build tool detected. No configuration file found in the current path: ${t}`,needAbort:!0})}({packageJsonContents:n.packageJsonContents,packages:["@million/lint"],cwd:e}),{buildTool:i,skipUpdateConfigFile:a}=t||{};return i&&(Xe.BUILD_TOOL=i.name),{...n,buildTool:i,skipUpdateConfigFile:a}},xe=async()=>{if(Xe.INIT_CRACO)return;const e=Xe.CWD,n=await async function(e,n=["@million/lint"]){const t=[],i=await ve(e),a=i?.packageJson;for(const e of n)a?.dependencies?.[e]&&t.push(e);return t}(e,["@million/lint"]);await async function({packageNames:e,alreadyInstalledPackageNames:n,askBeforeUpdating:t=!0,cwd:i,packageManager:a}){const r=e.map((e=>R(N(e)))).join(", "),o=n?.map((e=>R(N(e)))).join(", ");if(o?.length&&t&&!await ne(v.confirm({message:`The ${o} package is already installed. Do you want to update it to the latest version?`})))return;a=a||await be(i),Xe.PACKAGE_MANAGER=a.name;const l=v.spinner();l.start(`${n?.length?"Updating":"Installing"} ${r} with ${N(a.label)}.`);try{await me({packageManager:a,packageNames:e,cwd:i}),Q({type:"info",event:"wizard-package-manager",properties:{body:JSON.stringify(a)}}),l.stop(`${n?.length?"Updated":"Installed"} ${r} with ${N(a.label)}.`)}catch(e){Q({event:"wizard-failed-install",message:e,properties:{body:e}});const n="npm"===a.name&&e.message.includes("npm ERR"),t="yarn"===a.name&&e.message.includes("error "),i="pnpm"===a.name&&e.message.includes("ERR_"),r="bun"===a.name&&e.message.includes("error: "),o=n||t||i||r?"Error":"Warnings";if(v.log.error(P(`${o} during installation. ${e}`)),l.stop(),!await ne(v.confirm({message:"Would you like to continue anyway?"})))return Q({event:"wizard-abort",properties:{body:e.message},needAbort:!0})}}({packageNames:["@million/lint"],alreadyInstalledPackageNames:n,cwd:e})},je=new Set(["<",">","{","}","[","]"]),Ce=new Set(["for","do","while","if","else","return","function","var","let","const","true","false","undefined","this","new","delete","typeof","in","instanceof","void","break","continue","switch","case","default","throw","try","catch","finally","debugger","with","yield","async","await","class","extends","super","import","export","from","static"]),$e=new Set(["+","-","*","/","%","=","!","&","|","^","~","!","?",":",".",",",";","'",'"',".","(",")","[","]","#","@","\\",...je]),[Fe,Me,Se,Ie,Le,Ne,Ee,ze,Pe,Ae,Oe]=["identifier","keyword","string","class","property","entity","jsxliterals","sign","comment","break","space"].map(((e,n)=>n));function De(e){return/^[^\S\r\n]+$/g.test(e)}function _e(e){return $e.has(e)}function Re(e){return/^[\w_]+$/.test(e)||Be(e)}function Be(e){return/[^\u0000-\u007f]/.test(e)}function Ve(e){return/^[a-zA-Z]$/.test(e)}function Te(e){return Ve(e)||Be(e)}function qe(e){return Te(e[0])&&(1===e.length||Re(e.slice(1)))}function We(e){return"`"===e}function Ue(e){return'"'===e||"'"===e}function Ge(e){return"//"===(e=e.slice(0,2))||"/*"===e}function Je(e){let n="",t=-1,i=[-1,""],a=[-2,""];const r=[];let o=!1,l=0,s=!1,c=0;const u=()=>o&&!s&&!l,d=()=>l&&!u(),f=()=>!l&&u()&&!s&&c>0;let p=null,g=0,m=0;const y=()=>null!==p,b=()=>m>g,h=()=>y()||b();function w(e){const n="\n"===e;if(d()){if(y())return Se;const[,n]=i;if(qe(e)&&("<"===n||"</"===n))return Ne}if(f())return Ee;if(y())return Se;if(Ce.has(e))return"."===i[1]?Fe:Me;if(n)return Ae;if(De(e))return Oe;if(e.split("").every(_e))return ze;if(function(e){const n=e[0];return Re(n)&&n===n.toUpperCase()||"null"===e}(e))return d()?Fe:Ie;if(qe(e)){const e="."===i[1]&&qe(a[1]);if(!h()&&!e)return Fe;if(e)return Le}return Se}const v=(e,o)=>{if(o&&(n=o),n){t=e||w(n);const o=[t,n];t!==Oe&&t!==Ae&&(a=i,i=o),r.push(o)}n=""};for(let t=0;t<e.length;t++){const a=e[t],r=e[t-1],d=e[t+1],y=r+a,w=a+d;if(Ue(a)&&!f()){v(),"\\"!==r&&(p&&a===p?p=null:p||(p=a)),v(Se,a);continue}if(!b()&&"\\n"!==r&&We(a)){v(),v(Se,a),m++;continue}if(b()){if("\\n"!==r&&We(a)&&m>0){v(),m--,v(Se,a);continue}if("${"===w){g++,v(Se),v(ze,w),t++;continue}}if(m>0&&m===g&&"}"===a){v(),g--,v(ze,a);continue}if(u()&&"{"===a){v(),v(ze,a),s=!0;continue}if(o){if(!l&&"<"===a){v(),"/"===d?(l=2,n=w,t++):(l=1,n=a),v(ze);continue}if(l){if(">"===a&&!"/=".includes(r)){v(),1===l?(l=0,c++):(l=0,o=!1),v(ze,a);continue}if("/>"===w||"</"===w){"<"!==n&&"/"!==n&&v(),"/>"===w?l=0:c--,c||(o=!1),n=w,t++,v(ze);continue}if("<"===a){v(),n=a,v(ze);continue}if("-"===d&&!h()&&!f()&&n){v(Le,n+a+d),t+=1;continue}if("="===d&&!h()){const e=n?n+a:a;qe(e)&&(n=e,v(Le));continue}}}!l&&("<"===a&&Te(d)||"</"===w)&&(l="/"===d?2:1,"<"!==a||"/"!==d&&!Ve(d)||(o=!0));const j=Ue(x=a)||We(x),C=b(),$=!o&&("/"===(k=w)[0]&&!Ge(k[0]+k[1])),F=f();if(j||C||Ue(p))n+=a;else if($){v();const[r,o]=i;if($&&-1!==r&&(r!==ze||")"===o)&&r!==Pe){n=a,v();continue}const l=t++,s=()=>t>=e.length,c=()=>s()||"\n"===e[t];let u=!1;for(;!c();t++)if("/"===e[t]&&"\\"!==e[t-1]){for(u=!0;l!==t&&/^[a-z]$/.test(e[t+1])&&!c();)t++;break}l!==t&&u?(n=e.slice(l,t+1),v(Se)):(n=a,v(),t=l)}else if(Ge(w)){v();const i=t;if("/"===d)for(;t<e.length&&"\n"!==e[t];t++);else for(;t<e.length&&e[t-1]+e[t]!=="*/";t++);n=e.slice(i,t+1),v(Pe)}else" "===a||"\n"===a?" "!==a||!De(n)&&n&&!F?(v(),n=a,v()):(n+=a,"<"===d&&v()):s&&"}"===a?(v(),n=a,v(),s=!1):F&&!je.has(a)||(Re(a)===Re(n[n.length-1])||u())&&!$e.has(a)?n+=a:("</"===y&&(n=y),v(),"</"!==y&&(n=a),"</"===w||"/>"===w?(n=w,v(),t++):je.has(a)&&v())}var k,x;return v(),r}function He(e,n={showLineNumbers:!1}){const t=Je(e),i=[];let a=1;const r=[];function o(e){i.push(function(e){const t=n.showLineNumbers?`${E(`${a}`.padEnd(2," "))} `:"";return a++,`${t}${e}`}(e.map((([e,n])=>{switch(e){case 0:case 4:return _(n);case 1:case 2:case 7:return V(n);case 3:return O(n);case 5:return D(n);case 6:return B(n);case 8:return E(n);default:return n}})).join("")))}for(const e of t){const[n,t]=e;if(9!==n)if(t.includes("\n")){const e=t.split("\n");for(let t=0;t<e.length;t++)r.push([n,e[t]]),t<e.length-1&&(o(r),r.length=0)}else r.push(e);else r.push([n,""]),o(r),r.length=0}return r.length>0&&o(r),i.join("\n")}var Ye=async e=>{if(!e.check?.buildTool)return;if(e.check?.skipUpdateConfigFile)return;const n=Xe.CWD,t=e.check.buildTool;let i;v.note(`found existing ${t.configFilePath} file.`,`Transforming ${R(t.configFilePath)}`);try{let e=await async function(e,n){const t=h.default.join(n,e.configFilePath);return await j.default.readFile(t,{encoding:"utf-8"})}(t,n);const a=e,r=h.default.join(n,t.configFilePath);let o=!1;if(e.includes("@million/lint")&&e.includes("MillionLint")&&(o=!0),o)return Q({type:"info",event:"wizard-already-configured",message:A(`@million/lint is already configured in ${t.configFilePath}.`)});const l=v.spinner(),s=function(e){if(e.includes("module.exports =")||e.includes("exports."))return"cjs";if(e.includes("export default"))return"esm";return"unknown"}(e);if(Q({type:"info",event:"wizard-modify-config",properties:{body:{type:s,oldCode:a,filePath:r}}}),"unknown"===s)return Q({event:"wizard-unknown-module-type",message:"Unknown module type. Aborting.",needAbort:!0});let c;e=("esm"===s?"import MillionLint from '@million/lint';\n":"const MillionLint = require('@million/lint');\n")+e,"next"===t.name&&(c=await async function(){return x.default.existsSync("pages")?"pages":x.default.existsSync("app")?"app":x.default.existsSync("src/pages")?"pages":x.default.existsSync("src/app")?"app":await ne(v.select({message:"Will you use app Router or pages Router?",options:[{label:"App Router",value:"app"},{label:"Pages Router",value:"pages"}]}))}()),l.start(`Modifying config file ${R(t.configFilePath)}...`);const u=t.millionLint.configFileContent,d=t.millionLint.configFileContentRSC;i="app"===c?d:u;const f=await async function(e,n,t){const{name:i,bundler:a}=n;try{const n=(e,n,r)=>{const o=n(e),l=()=>F.callExpression(F.memberExpression(F.identifier("MillionLint"),F.identifier(a)),"craco"===i?[F.objectExpression([F.objectProperty(F.identifier("legacyHmr"),F.booleanLiteral(!0))])]:t?[F.objectExpression([F.objectProperty(F.identifier("rsc"),F.booleanLiteral(!0))])]:[]),s=()=>{const e=[];return e.push(l()),e};if("next"===i){if(F.isClassDeclaration(o)||F.isFunctionDeclaration(o)||F.isTSDeclareFunction(o))return;r(e,F.callExpression(l(),[o]))}if("vite"===i||"webpack"===i||"rollup"===i||"esbuild"===i||"rspack"===i||"craco"===i||"gatsby"===i||"astro"===i){let n=!1;if(e.traverse({ObjectProperty(t){if("craco"===i){if(F.isIdentifier(t.node.key)&&"plugins"===t.node.key.name&&F.isProperty(t.node)&&!F.isPattern(t.node.value)&&!F.isRestElement(t.node.value)&&!F.isIdentifier(t.node.value)){let i;n=!0,i=F.isObjectExpression(t.node.value)&&t.node.value.properties.some((e=>F.isObjectProperty(e)&&F.isIdentifier(e.key)&&"add"===e.key.name))?t.node.value.properties.find((e=>F.isObjectProperty(e)&&F.isIdentifier(e.key)&&"add"===e.key.name)):F.objectProperty(F.identifier("add"),F.arrayExpression(s())),e.insertBefore([F.variableDeclaration("const",[F.variableDeclarator(F.identifier("_plugins"),i.value)]),F.callExpression(F.memberExpression(F.identifier("_plugins"),F.identifier("unshift")),s())]),F.isObjectExpression(t.node.value)&&(t.node.value.properties=t.node.value.properties.filter((e=>!(F.isObjectProperty(e)&&F.isIdentifier(e.key)&&"add"===e.key.name))),t.node.value.properties.push(F.objectProperty(F.identifier("add"),F.identifier("_plugins"))))}}else!F.isIdentifier(t.node.key)||"plugins"!==t.node.key.name||!F.isProperty(t.node)||F.isPattern(t.node.value)||F.isRestElement(t.node.value)||F.isIdentifier(t.node.value)||(n=!0,e.insertBefore([F.variableDeclaration("const",[F.variableDeclarator(F.identifier("_plugins"),t.node.value)]),F.callExpression(F.memberExpression(F.identifier("_plugins"),F.identifier("unshift")),s())]),t.node.value=F.identifier("_plugins"))}}),!n){let n;const t=F.variableDeclaration("const",[F.variableDeclarator(F.identifier("_plugins"),F.arrayExpression(s()))]),a=F.objectProperty(F.identifier("plugins"),F.identifier("_plugins"));if(e.insertBefore([t]),"astro"===i){let e;o&&"CallExpression"===o.type&&F.isIdentifier(o.callee)&&"defineConfig"===o.callee.name&&(n=o.arguments[0]),n?.properties.length?e=n.properties.find((e=>!("ObjectProperty"!==e.type||!F.isIdentifier(e.key)||"vite"!==e.key.name||"ObjectExpression"!==e.value.type)))||F.objectProperty(F.identifier("vite"),F.objectExpression([a])):(e=F.objectProperty(F.identifier("vite"),F.objectExpression([a])),n=F.objectExpression([e])),o&&"CallExpression"===o.type&&F.isIdentifier(o.callee)&&"defineConfig"===o.callee.name&&(o.arguments[0]=n)}else"gatsby"===i?e.traverse({CallExpression(e){F.isMemberExpression(e.node.callee)&&F.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(n=e.node.arguments[0]),n?.properties.length?n.properties.push(a):n=F.objectExpression([a]),F.isMemberExpression(e.node.callee)&&F.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(e.node.arguments[0]=n)}}):"craco"===i?F.isObjectExpression(o)&&o.properties.push(F.objectProperty(F.identifier("webpack"),F.objectExpression([F.objectProperty(F.identifier("add"),F.identifier("_plugins"))]))):F.isObjectExpression(o)&&o.properties.push(a)}}},r=()=>({name:"wizard",visitor:{MemberExpression(e){const t=F.isIdentifier(e.node.object)&&"module"===e.node.object.name&&F.isIdentifier(e.node.property)&&"exports"===e.node.property.name,i=F.isIdentifier(e.node.object)&&"exports"===e.node.object.name;if(t||i){if(!e.parentPath.isAssignmentExpression())return;n(e.parentPath,(e=>e.node.right),((e,n)=>{e.node.right=n}))}},ExportDefaultDeclaration(e){n(e,(e=>e.node.declaration),((e,n)=>{e.node.declaration=n}))}}}),o=await p.transformAsync(e,{plugins:[r()],parserOpts:{plugins:["jsx","typescript"]}});return o?(Q({type:"info",event:"wizard-success-modify-config",properties:{body:JSON.stringify(o)}}),o.code):null}catch(e){return Q({event:"wizard-failed-get-new-file-content",message:"Unable to modify config file.",properties:{body:e},needAbort:!0}),null}}(e,t,"app"===c);if(!f)return Q({event:"wizard-no-changes-made",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${He(i,{showLineNumbers:!0})}`,needAbort:!0});const g=`${r}.temp`;await j.default.writeFile(g,f,{encoding:"utf-8",flag:"w"}),te(a,f,t.configFilePath),Xe.IDE_NAME?(await async function(e,n){try{await ie(`${Xe.CLI_COMMAND} --diff ${e} ${n}`)}catch(e){Q({event:"wizard-open-diff-failed",message:`Failed to open diff in ${Xe.IDE_NAME}`,properties:{body:e}})}}(r,g),l.stop(`Check ${R(t.configFilePath)} in ${N(String(Xe.IDE_NAME))} to review changes.`)):l.stop();const m=async()=>{await j.default.unlink(g),Q({event:"wizard-reverted-changes",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${He(i,{showLineNumbers:!0})}`,needAbort:!0})};await ne(v.confirm({message:"Does the config file look good?",initialValue:!0}),m)?await j.default.rename(g,r):await m()}catch(e){return v.log.error(e),Q({event:"wizard-failed-modify-config",message:`Failed to modify config file.\n\nHere is an installation reference:\n\n${He(i,{showLineNumbers:!0})}`,needAbort:!0})}},Ke=async()=>{const e=Xe.CWD;await async function(e){if(!e)return;const n="# Million Lint\n.million\n",t=h.default.join(e,".gitignore");if(x.default.existsSync(t)){const e=await j.default.readFile(t,"utf-8");if(e.includes(".million"))return;const i=`${e}\n${n}`;await j.default.writeFile(t,i),te(e,i,t)}else{const e=n;await j.default.writeFile(t,e),te("",e,t)}}(e)};var Xe={NAME:"",CWD:w.default.cwd(),CLI_COMMAND:"code",IDE_NAME:null,IDE_VERSION:null,MILLION_VERSION:null,INSTALL_VERSION:null,PACKAGE_MANAGER:"npm",BUILD_TOOL:null,INIT_CRACO:!1};exports.TelemetryStore=Xe,exports.beta=async function(e){try{v.intro(D(`⚡ ${N("Million Lint beta")}`)),await async function(e){const n=h.default.join(process.cwd());await v.group({getVersions:async()=>{const n=v.spinner();try{let{npmVersion:t,vscodeVersion:i}=e.reduce(((e,n)=>{try{const[t,i]=n.split("=");return{...e,[t.split("--")[1]]:i}}catch{return e}}),{npmVersion:"",vscodeVersion:""});if(!t||!i){n.start("Fetching latest versions");let e="version.txt";t?e=`version-npm-${t}.txt`:i&&(e=`version-vscode-${i}.txt`);const a=await fetch(`https://beta-lint-r2.million.dev/${e}`).then((e=>e.text())).then((e=>{const[n,a]=e.split("\n");return{npm:t||n,vscode:i||a}}));t=a.npm,i=a.vscode,n.stop()}return v.note(`Downloading packages for NPM ${t} and VSCode ${i}`,"Get ready to install the packages."),{npmVersion:t,vscodeVersion:i}}catch(e){return n.stop(),Q({event:"beta-error",message:"Failed to fetch versions",properties:{body:e}})}},fetchPackages:async({results:e})=>{if(!e.getVersions)return;const t=v.spinner();try{const{npmVersion:i,vscodeVersion:a}=e.getVersions;t.start("Downloading packages");const r=await fetch(`https://beta-lint-r2.million.dev/million-lint-${i}.tgz`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),o=h.default.join(n,`million-lint-${i}.tgz`);await j.default.writeFile(o,r);const l=await fetch(`https://beta-lint-r2.million.dev/million-lint-${a}.vsix`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),s=h.default.join(n,`million-lint-${a}.vsix`);await j.default.writeFile(s,l),t.message(`Downloaded packages: NPM ${i}, VSCode ${a}`);const c=await f.detect({programmatic:!0,cwd:n});if(!c)return Q({event:"beta-error",message:"No package manager found",properties:{body:"No package manager found"}});const u=await f.parseNi(c,[o]);if(!u)return Q({event:"beta-error",message:"Failed to create install command",properties:{body:"Failed to create install command"}});const{stderr:d}=await ie(u);if(d)return Q({event:"beta-error",message:"Failed to install packages",properties:{body:d}});const p=`code --install-extension ${s}`,{stderr:g}=await ie(p);if(g)return Q({event:"beta-error",message:"Failed to install packages",properties:{body:g}});await j.default.unlink(o),await j.default.unlink(s),t.stop()}catch(e){return t.stop(),Q({event:"beta-error",message:"Failed to fetch packages",properties:{body:e}})}}},{onCancel:({results:e})=>{Q({event:"beta-cancel",properties:{body:e}}),v.cancel("Million beta cancelled."),ee().then((()=>process.exit(1)))}})}(e),v.outro(`${A(N("✓ "))} You're all set! Enjoy! 🎉`)}catch(e){Q({event:"beta-error",message:e,properties:{body:e}})}},exports.install=async function(e,n=w.default.env.VERSION){try{Xe.NAME=e||"",Xe.INSTALL_VERSION=n||"",Xe.CWD=h.default.join(w.default.cwd()),t.intro(D(`⚡ ${N(e)} ${E(n||"")}`)),await async function(){await v.group({vscode:async()=>le(),check:async()=>ke(),install:async()=>xe(),updateConfigFile:async({results:e})=>Ye(e),others:async()=>Ke()},{onCancel:({results:e})=>{Q({event:"wizard-cancel",properties:{body:e}}),v.cancel("Million Lint setup cancelled."),ee().then((()=>w.default.exit(1)))}}),Q({type:"info",event:"wizard-complete",properties:{body:!0}}),ee().then((()=>w.default.exit(1)))}(),t.outro(`${A(N("✓ "))} You're all set!`)}catch(e){Q({event:"wizard-error",message:e,properties:{body:e}})}};